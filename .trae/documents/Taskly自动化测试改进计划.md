# Taskly自动化测试改进计划

## 1. 项目现状分析

### 1.1 项目结构
- 核心功能：`core/` 目录（数据库、列表、任务管理）
- GUI组件：`gui/` 目录（主窗口、侧边栏、任务面板等）
- 工具函数：`utils/` 目录（日期处理、路径管理）
- 测试代码：`test/` 目录（日期、数据库、列表、任务测试）

### 1.2 现有测试覆盖
- ✅ 日期工具测试（`test-date.rkt`）
- ✅ 数据库操作测试（`test-database.rkt`）
- ✅ 列表管理测试（`test-list.rkt`）
- ✅ 任务管理测试（`test-task.rkt`）
- ❌ GUI组件测试（未覆盖）

### 1.3 测试框架
- 使用Racket内置的 `rackunit` 测试框架
- 测试运行器：`run-all-tests.rkt`
- 测试方式：使用临时数据库文件，避免影响生产数据

## 2. 测试改进计划

### 2.1 核心原则
- **临时数据隔离**：所有测试使用独立的临时数据库文件
- **自动清理机制**：测试完成后自动删除所有临时文件
- **不影响生产数据**：确保测试运行不会修改任何生产文件
- **测试环境清洁**：保持测试目录整洁，只保留必要的测试代码

### 2.2 优化现有测试用例

#### 2.2.1 日期工具测试（`test-date.rkt`）
- 增加更多边界情况测试
- 测试无效日期格式的处理
- 测试月份天数的验证

#### 2.2.2 数据库操作测试（`test-database.rkt`）
- 增加事务处理测试
- 测试数据库关闭后的操作
- 测试并发访问情况

#### 2.2.3 列表管理测试（`test-list.rkt`）
- 测试空列表情况
- 测试重复列表名称处理
- 测试列表删除时的级联删除

#### 2.2.4 任务管理测试（`test-task.rkt`）
- 完善 `get-tasks-by-view` 函数测试
- 测试任务分组功能 `group-tasks-by-list`
- 测试任务创建时间的处理

### 2.3 添加新的测试用例

#### 2.3.1 路径工具测试（`test-path.rkt`）
- 测试默认数据库路径生成
- 测试目录存在性检查
- 测试路径字符串转换

#### 2.3.2 综合功能测试（`test-integration.rkt`）
- 测试列表和任务的综合操作
- 测试不同视图下的任务获取
- 测试任务状态转换流程

### 2.4 改进测试运行方式

#### 2.4.1 优化测试运行器
- 添加测试结果汇总
- 支持单独运行特定测试套件
- 支持测试过滤功能

#### 2.4.2 添加测试覆盖率统计
- 使用 `rackunit/test-coverage` 模块
- 生成覆盖率报告
- 监控覆盖率变化

### 2.5 完善临时数据清理机制

#### 2.5.1 确保临时文件路径规范
- 使用统一的临时文件命名格式
- 临时文件存放在 `test/` 目录下
- 文件名包含时间戳，确保唯一性

#### 2.5.2 自动清理机制
- 每个测试用例结束后立即清理临时文件
- 使用 `with-handlers` 确保即使测试失败也能清理
- 测试运行器添加全局清理机制

#### 2.5.3 防止误删除
- 只清理明确标识的临时文件
- 不删除任何不在 `test/` 目录下的文件
- 不删除任何生产数据文件

## 3. 实施步骤

### 3.1 第一步：优化现有测试用例
1. 修改 `test-date.rkt`，增加边界情况测试
2. 修改 `test-database.rkt`，增加事务和并发测试
3. 修改 `test-list.rkt`，增加空列表和级联删除测试
4. 修改 `test-task.rkt`，完善视图和分组测试

### 3.2 第二步：添加新的测试用例
1. 创建 `test/test-path.rkt`，测试路径工具函数
2. 创建 `test/test-integration.rkt`，测试综合功能

### 3.3 第三步：改进测试运行方式
1. 修改 `test/run-all-tests.rkt`，添加测试结果汇总
2. 集成测试覆盖率统计
3. 生成HTML测试报告

### 3.4 第四步：完善临时数据清理
1. 检查所有测试用例的临时文件清理逻辑
2. 确保所有临时文件都存放在 `test/` 目录下
3. 添加全局清理机制，防止遗漏

### 3.5 第五步：测试验证
1. 运行所有测试，确保通过
2. 检查 `test/` 目录，确保没有遗留临时文件
3. 分析测试覆盖率报告
4. 优化测试用例，提高覆盖率

## 4. 预期效果

### 4.1 测试覆盖率提升
- 核心功能测试覆盖率达到95%以上
- 工具函数测试覆盖率达到100%
- 数据库操作测试覆盖率达到100%

### 4.2 测试质量提高
- 包含更多边界情况和异常处理测试
- 测试用例更全面、更可靠
- 测试结果更易于理解和分析

### 4.3 开发效率提升
- 更快地发现和定位bug
- 更好地支持代码重构和功能扩展
- 提供可靠的回归测试保障

### 4.4 环境清洁
- 测试完成后自动清理所有临时数据
- 不影响代码提交
- 保持测试环境整洁

## 5. 技术栈

- **测试框架**：Racket `rackunit`
- **测试覆盖率**：`rackunit/test-coverage`
- **测试报告**：自定义HTML生成或第三方库
- **测试运行**：Racket命令行工具

## 6. 时间估算

- 优化现有测试用例：1-2小时
- 添加新的测试用例：2-3小时
- 改进测试运行方式：1-2小时
- 完善临时数据清理：0.5小时
- 测试验证和优化：1小时

**总计**：5.5-8.5小时

这个计划将帮助我们建立一个更全面、更可靠的自动化测试体系，同时确保测试完成后不会留下临时数据，不影响代码提交。