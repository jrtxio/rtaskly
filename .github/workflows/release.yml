name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Racket
        uses: Bogdanp/setup-racket@v1.10
        with:
          version: '8.12'
      
      - name: Run tests
        run: racket ./test/run-all-tests.rkt
      
      - name: Get version
        id: get_version
        run: |
          VERSION=$(racket get-version.rkt)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
        shell: bash
      
      - name: Build executable
        shell: bash
        run: |
          case ${{ runner.os }} in
            Linux) 
              raco exe -o taskly taskly.rkt
              raco distribute taskly-dist taskly
              tar -czf taskly-${{ env.VERSION }}-linux.tar.gz taskly-dist
              ;;
            macOS) 
              raco exe -o taskly taskly.rkt
              raco distribute taskly-dist taskly
              zip -r taskly-${{ env.VERSION }}-macos.zip taskly-dist
              ;;
            Windows) 
              raco exe -o taskly.exe taskly.rkt
              raco distribute taskly-dist taskly.exe
              powershell Compress-Archive -Path taskly-dist -DestinationPath taskly-${{ env.VERSION }}-windows.zip
              ;;
          esac
      
      - name: List build artifacts
        shell: bash
        run: |
          ls -la
      
      - name: Get CHANGELOG content
        id: get_changelog
        run: |
          # 提取CHANGELOG.md中当前版本的内容
          if grep -q "## [${{ env.VERSION }}]" CHANGELOG.md; then
            # 使用sed提取当前版本的变更日志
            CHANGELOG_CONTENT=$(sed -n "/## [${{ env.VERSION }}]/,/## \[/p" CHANGELOG.md | head -n -1)
          else
            # 如果找不到当前版本，使用默认内容
            CHANGELOG_CONTENT="## Release v${{ env.VERSION }}\n\nNo changes listed in CHANGELOG.md."
          fi
          # 将内容输出到环境变量，保留换行符
          echo "CHANGELOG_CONTENT<<EOF" >> $GITHUB_ENV
          echo "$CHANGELOG_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        shell: bash
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            taskly-*.zip
            taskly-*.tar.gz
          name: Release v${{ env.VERSION }}
          generate_release_notes: true
          body: |
            ${{ env.CHANGELOG_CONTENT }}
            
            --- 
            
            ## Automatic Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}