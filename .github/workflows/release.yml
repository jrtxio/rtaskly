name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # Linux builds
          - os: linux
            arch: x64
            runner: ubuntu-latest
            racket-version: '8.18'
          - os: linux
            arch: arm64
            runner: ubuntu-22.04-arm
            racket-version: '8.18'
          # macOS builds
          - os: macos
            arch: x64
            runner: macos-latest
            racket-version: '8.18'
          - os: macos
            arch: arm64
            runner: macos-14
            racket-version: '8.18'
          # Windows builds
          - os: windows
            arch: x64
            runner: windows-latest
            racket-version: '8.18'
          - os: windows
            arch: arm64
            runner: windows-11-arm
            racket-version: '8.18'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Racket
        uses: Bogdanp/setup-racket@v1.14
        with:
          version: ${{ matrix.racket-version }}
          architecture: ${{ matrix.arch }}
          variant: 'CS'
      
      - name: Show environment info
        shell: bash
        run: |
          echo "Runner OS: ${{ runner.os }}"
          echo "Runner Architecture: ${{ runner.arch }}"
          echo "Matrix OS: ${{ matrix.os }}"
      
      - name: Run tests
        shell: bash
        run: |
          cd tests
          if [ "${{ runner.os }}" == "Linux" ]; then
            xvfb-run -a racket run-all-tests.rkt
          else
            racket run-all-tests.rkt
          fi
      
      - name: Get version
        id: get_version
        shell: bash
        run: |
          VERSION=$(racket build/get-version.rkt)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      
      - name: Build executable
        shell: bash
        run: |
          ARCH=${{ matrix.arch }}
          OS=${{ matrix.os }}
          VERSION=${{ env.VERSION }}
          
          # 更新 main-frame.rkt 中的版本号 (仅临时修改用于构建)
          cp src/gui/main-frame.rkt src/gui/main-frame.rkt.bak
          # 使用 sed 替换版本号，注意跨平台兼容性
          sed -i.tmp "s|(define (get-app-version) \"[0-9]\+\.[0-9]\+\.[0-9]\+\")|(define (get-app-version) \"$VERSION\")|g" src/gui/main-frame.rkt || sed -i "s|(define (get-app-version) \"[0-9]\+\.[0-9]\+\.[0-9]\+\")|(define (get-app-version) \"$VERSION\")|g" src/gui/main-frame.rkt
          
          case "$OS" in
            linux)
              # Native build
              raco exe -o taskly src/taskly.rkt
              raco distribute taskly-dist taskly
              
              # Create deb package structure
              DEB_DIR="taskly-${VERSION}-${OS}-${ARCH}-deb"
              mkdir -p "${DEB_DIR}"/DEBIAN
              mkdir -p "${DEB_DIR}"/usr/bin
              mkdir -p "${DEB_DIR}"/usr/share/applications
              mkdir -p "${DEB_DIR}"/usr/share/icons/hicolor/512x512/apps
              
              # Copy executable to bin directory
              cp -r taskly-dist/* "${DEB_DIR}"/usr/bin/
              
              # Copy icon
              cp icons/taskly.png "${DEB_DIR}"/usr/share/icons/hicolor/512x512/apps/
              
              # Create desktop file
              printf '[Desktop Entry]\nName=Taskly\nComment=A simple task manager built with Racket\nExec=/usr/bin/taskly\nIcon=taskly\nTerminal=false\nType=Application\nCategories=Utility;Office;\n' > "${DEB_DIR}"/usr/share/applications/taskly.desktop
              
              # Create control file
              printf "Package: taskly\nVersion: ${VERSION}\nSection: utils\nPriority: optional\nArchitecture: ${ARCH}\nDepends: libc6 (>= 2.34)\nMaintainer: jrtxio <jrtxio@gmail.com>\nDescription: A simple and intuitive task management tool.\n" > "${DEB_DIR}"/DEBIAN/control
              
              # Build deb package
              dpkg-deb --build "${DEB_DIR}" "taskly-${VERSION}-${OS}-${ARCH}.deb"
              ;;
              
            macos)
              echo "Building on macOS ${{ runner.arch }}"
              raco exe -o taskly src/taskly.rkt
              raco distribute taskly-dist taskly
              
              # Install create-dmg
              brew install create-dmg
              
              # Create application bundle structure
              mkdir -p Taskly.app/Contents/MacOS
              mkdir -p Taskly.app/Contents/Resources
              
              # Copy executable and resources
              cp -r taskly-dist/* Taskly.app/Contents/MacOS/
              
              # Copy and configure Info.plist
              cp .github/macos/Info.plist Taskly.app/Contents/Info.plist
              sed -i.bak "s|0.0.1|$VERSION|g" Taskly.app/Contents/Info.plist
              rm Taskly.app/Contents/Info.plist.bak
              
              # Create ICNS from PNG (requires iconutil which is standard on macOS)
              mkdir taskly.iconset
              sips -z 16 16     icons/taskly.png --out taskly.iconset/icon_16x16.png
              sips -z 32 32     icons/taskly.png --out taskly.iconset/icon_16x16@2x.png
              sips -z 32 32     icons/taskly.png --out taskly.iconset/icon_32x32.png
              sips -z 64 64     icons/taskly.png --out taskly.iconset/icon_32x32@2x.png
              sips -z 128 128   icons/taskly.png --out taskly.iconset/icon_128x128.png
              sips -z 256 256   icons/taskly.png --out taskly.iconset/icon_128x128@2x.png
              sips -z 256 256   icons/taskly.png --out taskly.iconset/icon_256x256.png
              sips -z 512 512   icons/taskly.png --out taskly.iconset/icon_256x256@2x.png
              sips -z 512 512   icons/taskly.png --out taskly.iconset/icon_512x512.png
              iconutil -c icns taskly.iconset
              cp taskly.icns Taskly.app/Contents/Resources/
              
              # Create DMG file
              create-dmg \
                --volname "Taskly" \
                --volicon "icons/taskly.svg" \
                --window-pos 200 120 \
                --window-size 800 400 \
                --icon-size 100 \
                --icon "Taskly.app" 200 190 \
                --hide-extension "Taskly.app" \
                --app-drop-link 600 185 \
                "taskly-${VERSION}-${OS}-${ARCH}.dmg" \
                "Taskly.app"
              ;;
            
            windows)
              # Build standalone executable with embedded DLLs
              # 注意：--embed-dlls 尝试将所有依赖打包进 exe
              raco exe --gui --embed-dlls --ico icons/48x48.ico -o "taskly-${VERSION}-${OS}-${ARCH}.exe" src/taskly.rkt
              ;;
          esac
          
          # 恢复原始文件
          mv src/gui/main-frame.rkt.bak src/gui/main-frame.rkt

      - name: List build artifacts
        shell: bash
        run: |
          ls -la *.deb *.dmg *.exe 2>/dev/null || echo "No artifacts found"
      
      - name: Get CHANGELOG content
        id: get_changelog
        run: |
          if grep -q "## \[${{ env.VERSION }}\]" CHANGELOG.md; then
            CHANGELOG_CONTENT=$(sed -n "/## \[${{ env.VERSION }}\]/,/## \[/p" CHANGELOG.md | awk 'NR>1 {print prev} {prev=$0}')
          else
            CHANGELOG_CONTENT="## Release v${{ env.VERSION }}\n\nNo changes listed in CHANGELOG.md."
          fi
          echo "CHANGELOG_CONTENT<<EOF" >> $GITHUB_ENV
          echo "$CHANGELOG_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        shell: bash
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.deb
            *.dmg
            *.exe
          name: Release v${{ env.VERSION }}
          generate_release_notes: true
          body: |
            ${{ env.CHANGELOG_CONTENT }}
            
            ---
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}